+++
date = '2025-10-10T21:02:22+08:00'
draft = false
title = '对后端分层架构的思考'
+++

## **一、前言**

* **1.1 什么是分层架构？**  
  * 定义：将复杂的系统按职责划分为独立、可管理的模块。  
  * 目的：实现**高内聚、低耦合**。
* **1.2 分层带来的好处**  
  * **职责单一：** 每层只做一件事，代码更容易维护。  
  * **可测试性：** 业务逻辑（核心）独立出来，可以单独进行单元测试。  
  * **可替换性：** 替换数据库或Web框架时，只需要修改相邻层，不影响核心业务。  
  * **可读性：** 团队成员能快速定位代码功能。

## **二、经典分层架构分析**

### **2.1 Spring Boot（Java）的四层结构**

这是最传统的后端分层模式，结构清晰，易于理解。

* **Controller（控制层/接口层）**  
  * **职责：** 接收 HTTP 请求、参数校验、调用 Service 层、格式化 HTTP 响应。  
  * **特点：** 不包含任何业务逻辑。  
* **Service（业务逻辑层）**  
  * **职责：** 实现核心业务逻辑、处理事务、组织和协调 Repository 层的数据。  
  * **特点：** 业务代码的主体。  
* **Repository（数据访问层/持久层）**  
  * **职责：** 直接与数据库交互（CRUD操作）、封装底层数据访问细节。  
  * **特点：** 数据库访问的唯一入口。  
* **Model/Entity（模型层）**  
  * **职责：** 定义数据结构，通常与数据库表结构一一对应。

### **2.2 Django REST Framework (Python) 的分层与角色**

DRF 基于 Django 的 MVT（Model-View-Template）模式，但引入了 Serializer 角色。

* **Models（模型/数据层）**  
  * **职责：** 使用 Django ORM 定义数据库结构和关系、提供基础的数据查询方法。  
  * **对应传统层：** Model/Repository。  
* **Serializers（序列化器）**  
  * **职责：** **最核心的特性。** 实现数据校验（从外部输入到内部模型）、序列化（从内部模型到外部响应，如 JSON）。  
  * **对应传统层：** 部分参数校验（控制层）、数据格式转换。  
* **Views/ViewSet（视图/控制层）**  
  * **职责：** 接收 HTTP 请求、调用 Serializers 进行校验和序列化、协调 Models 层进行数据存取。  
  * **特点：** 业务逻辑通常分散在 Views 或 Serializers 中。  
  * **对应传统层：** Controller。

## **三、Kratos (Golang) 的 Clean Architecture 实践**

Kratos 架构更偏向**DDD（领域驱动设计）和Clean Architecture（整洁架构）**，强调业务核心的独立性。

* **Protobuf/API（契约层）**  
  * **职责：** 使用 Protobuf 定义接口（gRPC 或 HTTP）和所有数据传输结构（DTO）。  
  * **特点：** 约定了系统内外数据交互的契约。  
* **Server（接口适配层/控制层）**  
  * **职责：** 接收 gRPC/HTTP 请求、将请求参数转换为 Service 层的结构、调用 Service 层、将 Service 返回值转换为 Protobuf 响应。  
  * **对应传统层：** Controller。  
* **Service（应用服务层）**  
  * **职责：** 负责跨 Biz 层的**业务编排**、事务控制，以及参数的转换。  
  * **特点：** 连接 Server 和 Biz，作为应用入口。  
* **Biz（业务/领域层）**  
  * **职责：** **核心！** 实现纯粹的领域业务逻辑、不依赖任何基础设施（数据库、缓存等）。  
  * **特点：** 业务逻辑的独立核心，通过接口（Interface）与 Data 层解耦。  
  * **对应传统层：** Service (核心部分)。  
* **Data（基础设施层）**  
  * **职责：** 实现 Biz 层定义的接口，负责连接和操作外部系统（数据库、缓存、第三方服务）。  
  * **特点：** 负责 I/O 细节。  
  * **对应传统层：** Repository。

## **四、 跨框架分层对比与功能对应（核心对比表）**

| 功能角色 | Spring Boot | DRF | Kratos | 职责核心 |  
| 接口接入/控制 | Controller | Views/ViewSet | Server (gRPC/HTTP) | 接收请求，调用业务层，返回响应 |  
| 业务逻辑处理 | Service | (分散在 Views/Serializers) | Biz | 负责核心业务规则和流程 |  
| 数据校验/转换 | Controller/DTO | Serializers | Protobuf/DTO 转换 | 校验输入，格式化输出 |  
| 数据持久化 | Repository | Models (ORM) | Data | 负责与数据库、缓存等外部 I/O 交互 |  
| 数据结构定义 | Model/Entity | Models | Protobuf (Schema) | 定义数据结构和契约 |

## **五、 总结：分层的选择与架构的演进**

* 分层架构的本质是**隔离变化**：将变化频繁的 I/O 层和稳定不变的 Biz 层隔离开。  
* **DRF 适用于：** 快速开发、轻量级业务，Python生态友好。  
* **Spring Boot 适用于：** 企业级应用、功能稳定、团队习惯 Java 规范。  
* **Kratos 适用于：** 大型微服务、强调领域模型和解耦、追求高可维护性和测试性。



## 关于 Kratos 的四层分层架构

与 Springboot 的`Controller`->`Service`->`DAO`->`Model`

以及 Django REST Framework(以下称 DRF) 的`View`->`Serializer`->`Model`类似

Kratos也采用了按功能划分的分层架构：

`Server`->`Service`->`Biz`->`Data`

- `Server`层：处理HTTP/gRPC请求，进行路由分发，调用Service层
- `Service`层：处理具体的业务逻辑(相当于 Springboot 的 `Controller` 或 DRF 的 `View`)，调用Biz层
    > Service 层并不关心业务逻辑的具体实现(下层)，也不关心请求的具体协议(上层)，只负责根据请求调用相应的业务逻辑
- `Biz`层：处理核心业务逻辑(相当于 Springboot 的 `Service` 或 DRF 的 `View` + `Serializer(部分)`)，调用Data层
    > Biz 层不关心数据的具体存取方式(下层)，也不关心业务逻辑为何被调用(上层)，只负责实现具体的业务逻辑
- `Data`层：处理数据存取、存放数据模型(相当于Springboot 的 `DAO` + `Model` 或 DRF 的 `Serializer(部分)` + `Model`)，通常与数据库交互

这种分层架构的好处在于：
- 高内聚低耦合：每层职责单一，易于维护和扩展
- 易于测试：可以单独测试每一层的功能
- 灵活性高：可以更换某一层的实现而不影响其他层
- 适合微服务架构：每个服务可以独立部署和扩展

# Server

> 存放服务器层代码

## 主要功能

主要负责处理网络请求和响应，管理协议的解析和封装。
功能包括：
- gRPC 服务器和 HTTP 服务器的初始化与配置
- 请求的路由和分发
- 中间件的集成（如日志、认证、限流等）
- 错误处理和响应格式化

## 依赖关系

服务器层通常依赖服务层（Service）提供的业务逻辑接口。

# Service

> 存放服务实现代码

## 主要功能

类似于控制器层，负责处理来自客户端的请求，调用业务逻辑层 (Biz) 的接口来执行业务操作，并将结果返回给客户端。
功能包括：
- 解析请求参数
- 调用业务逻辑层接口
- 组装响应结果

## 依赖关系

服务层依赖于业务逻辑层 (Biz) 提供的业务接口。

# Data

> 存放数据访问层 (Repositories) 代码

## 主要功能

主要负责与数据库或其他存储系统进行交互，提供数据的增删改查等操作。

同时也负责外部数据源、其他微服务的集成。

功能包括：
- 数据库模型定义
- 数据库操作封装
- 数据库连接管理
- 数据缓存处理

## 依赖关系

通常依赖于数据库驱动或ORM框架等。

# Biz

> 存放业务逻辑层 (Usecase) 代码

## 主要功能

主要负责实现具体的业务逻辑，包括数据处理、规则校验、流程控制等。
功能包括：
- 处理业务逻辑
- 调用数据层接口
- 组装响应结果

## 依赖关系

业务逻辑层通常依赖数据访问层 (Data) 提供的数据接口。


# Conf

存放定义配置文件格式的 `proto` 文件，负责配置的加载和解析。
